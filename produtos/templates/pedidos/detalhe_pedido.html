{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Detalhes do Pedido #{{ pedido.id }}</title>
    <link rel="stylesheet" href="{% static 'produtos/estoque_lista.css' %}">
    <link rel="stylesheet" href="{% static 'produtos/detalhe_pedido.css' %}">
</head>

<body>
    <div class="container">
        
        <div class="pedido-info">
            <h1>Pedido de Solicitação #{{ pedido.id }}</h1>
            
            {% if pedido.status == 'REJEITADO' and pedido.justificativa_rejeicao %}
                <div class="aviso-rejeicao">
                    <h3>⛔ Pedido Rejeitado</h3>
                    <p><strong>A nutricionista deixou a seguinte observação:</strong></p>
                    <div class="texto-justificativa">
                        "{{ pedido.justificativa_rejeicao }}"
                    </div>
                </div>
            {% endif %}
            <p><strong>Status:</strong> {{ pedido.get_status_display }}</p>
            <p><strong>Data:</strong> {{ pedido.data_pedido|date:"d/m/Y H:i" }}</p>
        </div>

        <div class="itens-lista">
            <h2>Itens no Pedido</h2>
            {% if itens %}
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in itens %}
                    <tr>
                        <td>{{ item.produto.nome }}</td>
                        <td>{{ item.quantidade }}</td>
                        <td>
                            {% if pedido.status == 'PENDENTE' %}
                            <form method="post" action="{% url 'remover_item_pedido' item.id %}" style="display: inline-table;">
                                {% csrf_token %}
                                <button type="submit" onclick="return confirm('Tem certeza que deseja remover este item?');">Remover</button>
                            </form>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhum item adicionado a este pedido ainda.</p>
            {% endif %}
        </div>
        <hr>

        {% if pedido.status == 'PENDENTE' %}
        <div class="form-adicionar">
            <h2>Adicionar Novo Item</h2>
            <form method="post" id="form-adicionar-item">
                {% csrf_token %}
                {{ form.as_p }}
                
                <button type="submit" class="btn btn-primary">Adicionar Item ao Pedido</button>

                {% if not pedido.carne_comprada and not pedido.observacao_carne %}
                    <button type="submit" form="form-especial" class="btn btn-success">Salvar Solicitação</button>
                {% endif %}
            </form>
        </div> 
        {% endif %}

        <br>

        <h3>Solicitação Especial</h3>

        {% if pedido.carne_comprada %}
            
            {% if pedido.justificativa_secretario %}
                <div class="card border-danger mb-3">
                    <div class="card-header bg-danger text-white">
                        <strong>❌ Solicitação Não Atendida</strong>
                    </div>
                    <div class="card-body text-danger">
                        <h5 class="card-title">A secretaria não pôde realizar esta compra.</h5>
                        <p class="card-text">
                            <strong>Motivo informado:</strong><br>
                            <div class="texto-justificativa">
                                "{{ pedido.justificativa_secretario }}"
                            </div>
                        </p>
                        <hr>
                        <p class="card-text text-dark">
                            <strong>Item que havia sido solicitado:</strong><br>
                            {{ pedido.observacao_carne|linebreaks }}
                        </p>
                    </div>
                </div>

            {% else %}
                <div class="card border-success mb-3">
                    <div class="card-header bg-success text-white">
                        <strong>✅ Compra Realizada!</strong>
                    </div>
                    <div class="card-body text-success">
                        <h5 class="card-title">O Secretário já efetuou esta compra.</h5>
                        <p class="card-text text-dark">
                            <strong>Item solicitado:</strong><br>
                            {{ pedido.observacao_carne|linebreaks }}
                        </p>
                        <hr>
                        <small class="text-muted">Este item foi processado e arquivado pela secretaria.</small>
                    </div>
                </div>
            {% endif %}

        {% elif pedido.observacao_carne %}
            <div class="alert" role="alert">
                <h4 class="alert-heading alert-warning">⏳ Enviado para a Secretaria</h4>
                <p>Você solicitou: <strong>{{ pedido.observacao_carne }}</strong></p>
                <hr>
                <p class="mb-0">Aguardando o Secretário visualizar e processar o pedido.</p>
            </div>

            <details>
                <summary class="sumario">Clique para editar o texto</summary>
                <br>
                <form method="POST" action="{% url 'finalizar_pedido' pedido.id %}">
                    {% csrf_token %}
                    <textarea name="obs_carne" class="form-control" rows="3">{{ pedido.observacao_carne }}</textarea>
                    <button type="submit" class="btn btn-primary mt-2">Atualizar Texto</button>
                </form>
            </details>

        {% else %}
            <p>Use este espaço para pedir itens que vêm direto do mercado e não passam pelo estoque (ex: carne).</p>
            <form method="POST" action="{% url 'finalizar_pedido' pedido.id %}" id="form-especial">
                {% csrf_token %}
                <div class="form-group mb-3">
                    <textarea name="obs_carne" class="form-control" rows="5" placeholder="Digite aqui sua solicitação (Ex: 20kg de Acém, 10kg de Frango)..."></textarea>
                </div>
            </form>
        {% endif %}

        <br><br>

        <div class="button-place">
            <a href="{% url 'menu_diretor' %}" class="btn-custom-modern btn-back-dark">← Voltar ao Menu</a>
            <a href="{% url 'meus_pedidos' %}" class="btn-custom-modern btn-primary-blue">Ver Meus Pedidos</a>
        </div>
    </div>
</body>
</html>